resource "aws_ssm_document" "default" {
  name            = "CronJob"
  document_type   = "Command"
  target_type     = "/AWS::EC2::Instance"
  document_format = "YAML"

  content = <<-DOC
    ---
    schemaVersion: "2.2"
    description: "Run backup scripts"
    parameters:
      dbpassword:
        type: "String"
        description: "Database Password."
    mainSteps:
    - action: "aws:runShellScript"
      name: "backup"
      inputs:
        workingDirectory: "{{.}}"
        runCommand:
        - "if [ -d "/backup" ] then"
        - "echo \"Backing up...\""
        - "sudo mysqldump -u root -p{{ dbpassword }} --all-databases > /backup/db_backup.sql"
        - "sudo tar -czf /backup/app.tar.gz /var/www/ghost/"
        - "else"
        - "echo \"Creating backup directory...\""
        - "sudo mkdir /backup"
        - "sudo mysqldump -u root -p{{ dbpassword }} --all-databases > /backup/db_backup.sql"
        - "sudo tar -czf /backup/app.tar.gz /var/www/ghost/"
        - "fi"
DOC
}
